---
title: "SN_Study_network_maps"
author: "Natalie Samuels"
date: "2/13/2019"
output: html_document
---

Ojective: Convert network edge lists to gexf graph objects.

```{r load packages}

library(igraph)
library(rgexf)
library(stringr)
library(tidyr)
library(dplyr)

```

Test Data for Demo
```{r prepare test data}

# read in test data
df.cedro_closefrds_noms = read.csv('Cedro_CloseFrds_noms_fall2018_week9.csv')

# create test edge list
df.cedro_closefrds_edges = df.cedro_closefrds_noms %>% 
  gather(key = 'Nomination_Type', value = 'Nominations', CloseFrds_1:CloseFrds_6) %>% 
  select(-Nomination_Type) %>% 
  filter(Nominations != 'NONE' & Nominations != '')

```


STEP 1: Create gexf object attributes

1a) Create two-column data-frame of "id"s and "label"s representing nodes
```{r create nodes}

fun.create_nodes = function(df.network_edge_list) 
{
  # get unique PIDs and rename to ids
  df.unique_sources = df.network_edge_list %>% 
    select(PID) %>% 
    unique() %>% 
    rename(id = PID)

  # get unique Nominations and rename to ids
  df.unique_targets = df.network_edge_list %>% 
    select(Nominations) %>% 
    unique() %>% 
    rename(id = Nominations)

  # combine all possible ids and extract unique
  df.possible_ids = rbind(df.unique_sources, df.unique_targets)
    df.unique_ids = df.possible_ids %>% 
    unique()
  
  # create node data frame with blank 'label' column
  df.nodes = df.unique_ids
  df.nodes['label'] = ''
  
  return(df.nodes)
}

```


1b) Create two-column data-frame containing "source" and "target" for each edge
```{r create edges}

fun.create_edges = function(df.network_edge_list) 
{
  # rename 'PID' to 'source' and 'Nominations' to 'target'
  df.edges = df.network_edge_list %>% 
    rename(source = PID) %>% 
    rename(target = Nominations) %>% 
    select(source, target)
  
  return(df.edges)
}

```


1c) Create data-frame containing color info (RGBA) for each element
```{r element color}

fun.element_color = function(df.element, r, g, b, a) 
{
  # create RGBA columns and assign values
  df.element['r'] = r
  df.element['g'] = g
  df.element['b'] = b
  df.element['a'] = a
  
  # select relevant columns
  df.element_color = df.element %>% 
    select(r, g, b, a)
  
  return(df.element_color)
}

```


1d) Create column vector containing size info (based on in-degree) for each node
```{r node size}

fun.node_size = function(df.network_edge_list, df.nodes) 
{
  # create graph object
  g.network = graph_from_data_frame(df.network_edge_list, directed = TRUE, vertices = NULL)
  
  # calculate in-degree for PIDs (note that vector elements are named by PID)
  v.in_degree = degree(g.network, 
                      v = V(g.network), 
                      mode = c("in"), 
                      loops = FALSE, 
                      normalized = FALSE)
  
  # assign in-degree to each node
  df.nodes['in_degree'] = v.in_degree[match(df.nodes$id, names(v.in_degree))]
  
  # scale in-degree values for visibility
  df.nodes = df.nodes %>% 
    mutate(in_degree = in_degree*3 + 15)
  
  # acquire and return in-degree column as vector
  return(df.nodes[['in_degree']])
}

```


1e) Create column vector containing weight info for each edge
```{r edge weight}

fun.edge_weight = function(df.edges, weight) 
{
  # create weight column and assign value
  df.edges['weight'] = weight
  
  # acquire and return weight column as vector
  return(df.edges[['weight']])
}

```


STEP 2: Create gexf object file name components

2a) Extract dorm name or network type
```{r get name}

fun.get_name = function(df.network_edge_list, name_type) 
{
  dorm_network_type = names(df.network_edge_list)
  
  name_index = ifelse(name_type == 'dorm', 1, 2)
  
  name = str_extract_all(dorm_network_type, "\\S+")[[1]][[name_index]]
  
  return(name)
}

```


2b) Extract network type
```{r}
pass
```


STEP 3: Create, customize, and write gexf objects. 
```{r main}

fun.create_gexf = function(df.network_edge_list) 
{
  # set node attributes
  df.nodes = fun.create_nodes(df.network_edge_list)
  df.node_color = fun.element_color(df.nodes, r=0, g=102, b=204, a=1)
  v.node_size = fun.node_size(df.network_edge_list, df.nodes)
  
  # set edge attributes
  df.edges = fun.create_edges(df.network_edge_list)
  df.edge_color = fun.element_color(df.edges, r=0, g=0, b=0, a=1)
  v.edge_weight = fun.edge_weight(df.edges, weight=100)

  write.gexf(df.nodes, df.edges, 
             nodesVizAtt = list(color = df.node_color, size = v.node_size), 
             edgesVizAtt = list(color = df.edge_color, size = v.edge_weight), 
             output = '/Users/namuels/Desktop/test.gexf', 
             defaultedgetype = "directed")
}

```


STEP 4: Gnerate plots. 
```{r generate plots}

fun.create_gexf(df.cedro_closefrds_edges)

```

