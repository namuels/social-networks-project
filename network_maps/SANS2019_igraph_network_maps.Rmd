---
title: "SANS2019_igraph_network_maps"
author: "Natalie Samuels"
date: "4/30/2019"
output: html_document
---

Ojective: Convert network edge list dataframess to igraph plots

```{r load packages}

library(gplots)
library(rgexf)
library(stringr)
library(tidyr)
library(dplyr)

```


STEP 1: Create igraph object attributes

1a) Create edge dataframe containing "source" and "target" for each edge.
```{r create edges}

fun.create_edges = function(df.network_edge_list) 
{
  # rename 'PID' to 'source' and 'Nominations' to 'target'
  df.edges = df.network_edge_list %>% 
    rename(source = PID) %>% 
    rename(target = Nominations) %>% 
    select(source, target)
  
  return(df.edges)
}

```


1b) Create node dataframe containing "id"s for each node.
```{r create nodes}

fun.create_nodes = function(df.network_edge_list) 
{
  # get unique PIDs and rename to ids
  df.unique_sources = df.network_edge_list %>% 
    select(PID) %>% 
    unique() %>% 
    rename(id = PID)

  # get unique Nominations and rename to ids
  df.unique_targets = df.network_edge_list %>% 
    select(Nominations) %>% 
    unique() %>% 
    rename(id = Nominations)

  # combine all possible ids and extract unique
  df.possible_ids = rbind(df.unique_sources, df.unique_targets)
    df.unique_ids = df.possible_ids %>% 
    unique()
  
  df.nodes = df.unique_ids
  
  return(df.nodes)
}

```


1c) Add size info (based on ambient empathy) for each node to node dataframe
```{r node size}

fun.add_node_size = function(df.nodes) 
{
  # read in ambient empathy data
  df.ambient_empathy = read.csv(file = "ambient_empathy.csv")
  
  # assign ambient empathy and trait empathy to each node
  df.nodes['ambient_empathy'] = df.ambient_empathy$total_weighted_empathy_network[match(df.nodes$id,
                                                                                        df.ambient_empathy$PID)]
  df.nodes['trait_empathy'] = df.ambient_empathy$nomination_empathy[match(df.nodes$id, 
                                                                          df.ambient_empathy$Nomination)]
  
  # acquire and return nodes dataframe
  return(df.nodes)
}

```


STEP 2: Create network plots

2a) Plotting function - ambient
```{r create ambient plot}

fun.create_ambient_plot = function(df.network_edge_list, plot_title) 
{
  # create edge data frame
  df.edges = fun.create_edges(df.network_edge_list)
  
  # create node data frame
  df.nodes = fun.create_nodes(df.network_edge_list) 
  df.nodes = fun.add_node_size(df.nodes)
  
  # create igraph object
  g.network = graph_from_data_frame(d = df.edges, vertices = df.nodes, 
                                    directed = TRUE)
  g.network = simplify(g.network, remove.multiple = TRUE, remove.loops = TRUE) 
  
  #grab ambient empathy for vertex size
  ambient_empathy = V(g.network)$ambient_empathy
  
  plot(g.network, 
       # edge attributes
       edge.arrow.size = .1, edge.color = 'grey50', 
       arrow.mode = 3,
       # node attributes
       vertex.label = NA, 
       vertex.color = ifelse(is.na(ambient_empathy), 'grey', 'blue'), 
       vertex.size = ifelse(is.na(ambient_empathy), 5, ambient_empathy/5 + 5), 
       # other attributes
       main = plot_title, layout = layout_with_fr)
}

```


2a) Plotting function - trait
```{r create trait plot}

fun.create_trait_plot = function(df.network_edge_list, plot_title) 
{
  # create edge data frame
  df.edges = fun.create_edges(df.network_edge_list)
  
  # create node data frame
  df.nodes = fun.create_nodes(df.network_edge_list) 
  df.nodes = fun.add_node_size(df.nodes)
  
  # create igraph object
  g.network = graph_from_data_frame(d = df.edges, vertices = df.nodes, 
                                    directed = TRUE)
  g.network = simplify(g.network, remove.multiple = TRUE, remove.loops = TRUE) 
  
  #grab trait empathy for vertex size
  trait_empathy = V(g.network)$trait_empathy
  
  plot(g.network, 
       # edge attributes
       edge.arrow.size = .1, edge.color = 'grey50', 
       arrow.mode = 3,
       # node attributes
       vertex.label = NA, 
       vertex.color = ifelse(is.na(trait_empathy), 'grey', 'blue'), 
       vertex.size = ifelse(is.na(trait_empathy), 5, trait_empathy*3 + 5), 
       # other attributes
       main = plot_title, layout = layout_with_fr)
}

```


2b) Prepare network names
```{r network_names}

fun.network_names = function(edge_list_dataframes) 
{
  v.network_names = names(edge_list_dataframes)
  
  v.network_names = gsub("CloseFrds", "Close Friends Network", v.network_names)
  v.network_names = gsub("EmpSupp", "Empathy Network", v.network_names)
  v.network_names = gsub("Gossip", "Gossip Network", v.network_names)
  v.network_names = gsub("Liked", "Popular Network", v.network_names)
  v.network_names = gsub("NegAffPres", "Feel Bad Network", v.network_names)
  v.network_names = gsub("NegEmoSupp", "Bad News Network", v.network_names)
  v.network_names = gsub("Persuasive", "Persuasive Network", v.network_names)
  v.network_names = gsub("PosAffPres", "Feel Good Network", v.network_names)
  v.network_names = gsub("PosEmoSupp", "Good News Network", v.network_names)
  v.network_names = gsub("Responsive", "Support Network", v.network_names)
  v.network_names = gsub("SocAdvice", "Advice Network", v.network_names)
  v.network_names = gsub("SpendTime", "Time Spent Network", v.network_names)
  
  return(v.network_names)
}

```


2c) Create ambient empathy plot PDFs
```{r individual ambient plot pdfs}

fun.write_amb_emp_plot_pdf = function(edge_list_dataframes) 
{
  # prepare list of network names
  v.network_names = fun.network_names(edge_list_dataframes) 

  for (i in 1:length(edge_list_dataframes)) {
    df.network_edge_list = edge_list_dataframes[[i]]
    network_name = v.network_names[[i]]
    
    # remove spaces from network_name for saving
    file_name = gsub(' ', '_', network_name)
    path_name = paste0('amb_emp_network_plots/', file_name, '.pdf')
    
    # write plot to pdf
    pdf(path_name)
    fun.create_ambient_plot(df.network_edge_list, plot_title = network_name) 
    dev.off()
  }
  
}

```


2c) Create trait empathy plot PDFs
```{r individual trait plot pdfs}

fun.write_trait_emp_plot_pdf = function(edge_list_dataframes) 
{
  # prepare list of network names
  v.network_names = fun.network_names(edge_list_dataframes) 

  for (i in 1:length(edge_list_dataframes)) {
    df.network_edge_list = edge_list_dataframes[[i]]
    network_name = v.network_names[[i]]
    
    # remove spaces from network_name for saving
    file_name = gsub(' ', '_', network_name)
    path_name = paste0('trait_emp_network_plots/', file_name, '.pdf')
    
    # write plot to pdf
    pdf(path_name)
    fun.create_trait_plot(df.network_edge_list, plot_title = network_name) 
    dev.off()
  }
  
}

```


3) create JRo Close Friends "egonets"
```{r jro close friends egonet}

df.jro_closefrds = edge_list_dataframes[["JRo CloseFrds"]]

# pick sources in JRo with highest and lowest ambient empathy
df.jro_ambient_empathy = df.ambient_empathy %>% 
  filter(Dorm == "JRo")

# JRo max ambient empathy
max_jro_amb_emp = df.jro_ambient_empathy[which.max(df.jro_ambient_empathy$total_weighted_empathy_network), 'total_weighted_empathy_network']

max_jro_amb_emp_pid = c('qE7hQs4Yjh')

df.max_jro_ambient_empathy = df.jro_ambient_empathy %>% 
  filter(total_weighted_empathy_network == max_jro_amb_emp)

# JRo min ambient empathy
min_jro_amb_emp = df.jro_ambient_empathy[which.min(df.jro_ambient_empathy$total_weighted_empathy_network), 'total_weighted_empathy_network']

min_jro_amb_emp_pid = c('h2yn09VXH2')

df.min_jro_ambient_empathy = df.jro_ambient_empathy %>% 
  filter(total_weighted_empathy_network == min_jro_amb_emp)
```


```{r JRo max amb emp egonet}

# create JRo edge dataframe
# rename 'PID' to 'source' and 'Nominations' to 'target'
df.jro_edges = df.jro_closefrds %>% 
  rename(source = PID) %>% 
  rename(target = Nominations) %>% 
  select(source, target)

# create JRo node dataframe
# get unique PIDs and rename to ids
df.jro_unique_sources = df.jro_closefrds %>% 
  select(PID) %>% 
  unique() %>% 
  rename(id = PID)

# get unique Nominations and rename to ids
df.jro_unique_targets = df.jro_closefrds %>% 
  select(Nominations) %>% 
  unique() %>% 
  rename(id = Nominations)

# combine all possible ids and extract unique
df.jro_possible_ids = rbind(df.jro_unique_sources, df.jro_unique_targets)

df.jro_unique_ids = df.jro_possible_ids %>% 
  unique()

df.jro_nodes = df.jro_unique_ids

# add node size (by weighted empathy)

# assign weighted empathy to each nomination
df.jro_nodes['weighted_empathy_max'] = 
  df.max_jro_ambient_empathy$weighted_empathy[match(df.jro_nodes$id, df.max_jro_ambient_empathy$Nomination)]

# add node label info
df.jro_nodes['label_max'] = 
  ifelse(match(df.jro_nodes$id, max_jro_amb_emp_pid) == 1, 'MAX', NA)

df.jro_nodes['label_min'] = 
  ifelse(match(df.jro_nodes$id, min_jro_amb_emp_pid) == 1, 'MIN', NA)
  
# create igraph object

g.jro_max_network = graph_from_data_frame(d = df.jro_edges, vertices = df.jro_nodes, 
                                  directed = TRUE)

# grab weighted empathy for vertex size
weighted_empathy_max = V(g.jro_max_network)$weighted_empathy_max

# convert weighted empathy to color gradient

resolution = 8
palette = colorRampPalette(c('blue','red'))

max_weighted_empathy_max = max(V(g.jro_max_network)$weighted_empathy_max, na.rm=TRUE)
weighted_empathy_max_ratio = V(g.jro_max_network)$weighted_empathy_max / max_weighted_empathy_max

graphCol_max = palette(resolution)[as.numeric(cut(weighted_empathy_max_ratio, breaks=resolution))]

# get node labels
label_max = V(g.jro_max_network)$label_max

# create plot and write to pdf
pdf('jro_egonets/jro_max.pdf')
plot(g.jro_max_network, 
     # edge attributes
     edge.arrow.size = .1, edge.color = 'grey50', 
     arrow.mode = 3,
     # node attributes
     vertex.label = NA, 
     vertex.shape = ifelse(is.na(label_max), 'circle', 'square'), 
     vertex.color = ifelse(! is.na(graphCol_max), graphCol_max, 
                           ifelse(is.na(label_max), 'grey', 'black')), 
     vertex.size = ifelse(is.na(weighted_empathy_max), 5, weighted_empathy_max*5 + 5), 
     # other attributes
     main = '\"Available\" Empathy for Student with Highest Ambient Empathy\n 
     (JRo Close Friends Network)',
     layout = layout_with_fr)
dev.off()
```

```{r JRo min amb emp egonet}

# add node size (by weighted empathy)

# assign weighted empathy to each nomination
df.jro_nodes['weighted_empathy_min'] = 
  df.min_jro_ambient_empathy$weighted_empathy[match(df.jro_nodes$id, df.min_jro_ambient_empathy$Nomination)]
  
# create igraph object

g.jro_min_network = graph_from_data_frame(d = df.jro_edges, vertices = df.jro_nodes, 
                                  directed = TRUE)

# grab weighted empathy for vertex size
weighted_empathy_min = V(g.jro_min_network)$weighted_empathy_min

# convert weighted empathy to color gradient

resolution = 8
palette = colorRampPalette(c('blue','red'))

max_weighted_empathy_min = max(V(g.jro_min_network)$weighted_empathy_min, na.rm=TRUE)
weighted_empathy_min_ratio = V(g.jro_min_network)$weighted_empathy_min / max_weighted_empathy_min

graphCol_min = palette(resolution)[as.numeric(cut(weighted_empathy_min_ratio, breaks=resolution))]

# get node labels
label_min = V(g.jro_min_network)$label_min

# create plot and write to pdf
pdf('jro_egonets/jro_min.pdf')
plot(g.jro_min_network, 
     # edge attributes
     edge.arrow.size = .1, edge.color = 'grey50', 
     arrow.mode = 3,
     # node attributes
     vertex.label = NA, 
     vertex.shape = ifelse(is.na(label_min), 'circle', 'square'), 
     vertex.color = ifelse(! is.na(graphCol_min), graphCol_min, 
                           ifelse(is.na(label_min), 'grey', 'black')), 
     vertex.size = ifelse(is.na(weighted_empathy_min), 5, weighted_empathy_min*5 + 5), 
     # other attributes
     main = '\"Available\" Empathy for Student with Lowest Ambient Empathy\n 
     (JRo Close Friends Network)',
     layout = layout_with_fr)
dev.off()

```



